<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Componentes Ativos - Louvor</title>
  <link rel="manifest" href="manifest.json">
  <script src="config.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    :root {
      --primary: #2c3e50;
      --accent: #27ae60;
      --bg: #f4f7f6;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    /* CSS Update */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 25px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
    }

    .header h2 {
      margin: 0;
      font-size: 1.4rem;
      color: var(--primary);
    }

    .header p {
      display: none;
    }

    /* Hide subtitle for cleaner look */
    .nav-btn {
      background: none;
      border: none;
      font-size: 1.3rem;
      color: var(--primary);
      cursor: pointer;
    }

    .comp-card {
      background: white;
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      overflow: hidden;
    }

    .comp-header {
      padding: 15px;
      display: flex;
      align-items: center;
      cursor: pointer;
      gap: 15px;
    }

    .avatar {
      width: 55px;
      height: 55px;
      border-radius: 50%;
      object-fit: cover;
      background: #eee;
      border: 2px solid var(--accent);
    }

    .comp-info-main {
      flex-grow: 1;
    }

    .comp-name {
      font-weight: bold;
      color: #333;
    }

    .comp-status {
      font-size: 0.7rem;
      font-weight: bold;
      color: var(--accent);
      background: #e8f5e9;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .comp-details {
      display: none;
      padding: 15px;
      border-top: 1px solid #eee;
      background: #fafafa;
    }

    .comp-card.active .comp-details {
      display: block;
    }

    .comp-card.active .fa-chevron-down {
      transform: rotate(180deg);
    }

    .action-btns {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }

    .btn-icon {
      flex: 1;
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      text-decoration: none;
      color: white;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .btn-tel {
      background: #3498db;
    }

    .btn-wpp {
      background: #25d366;
    }

    .extra-section {
      margin-top: 15px;
      border-top: 1px dashed #ccc;
      padding-top: 10px;
    }

    .extra-section h4 {
      font-size: 0.85rem;
      margin-bottom: 8px;
      color: var(--primary);
      text-transform: uppercase;
    }

    .list-item {
      font-size: 0.85rem;
      padding: 5px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      color: #555;
    }

    .loading-small {
      font-size: 0.75rem;
      color: #999;
      font-style: italic;
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="header">
      <button class="nav-btn" onclick="window.location.href='index.html'"><i class="fas fa-arrow-left"></i></button>
      <h2><i class="fas fa-microphone-lines"></i> Equipe</h2>
      <button class="nav-btn" onclick="iniciar(true)"><i class="fas fa-sync-alt"></i></button>
    </div>
    <div id="listaComponentes">
      <div style="text-align:center; padding:50px;"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>
    </div>
  </div>

  <script>
    const SCRIPT_URL = APP_CONFIG.SCRIPT_URL;

    let bancoImagens = [];

    async function iniciar(force = false) {
      const container = document.getElementById('listaComponentes');
      const cachedComp = localStorage.getItem('offline_componentes');

      // Se tiver cache e não for forçado, usa cache.
      // As imagens são menos críticas, se não tiver cache delas, busca em background, mas renderiza os nomes.
      if (!force && cachedComp) {
        const cachedImg = localStorage.getItem('offline_imagens');
        if (cachedImg) bancoImagens = JSON.parse(cachedImg);
        renderizar(JSON.parse(cachedComp).filter(c => c.Ativo && c.Ativo.toString().toUpperCase().trim() === "SIM"));
        // Se não tiver imagens no cache, busca silenciosamente
        if (!cachedImg) fetchImages();
        return;
      }

      container.innerHTML = '<div style="text-align:center; padding:50px;"><i class="fas fa-spinner fa-spin"></i> Atualizando...</div>';

      try {
        // Busca Paralela
        const [resComp, resImg] = await Promise.all([
          fetch(SCRIPT_URL + "?sheet=Componentes"),
          fetch(SCRIPT_URL + "?action=getImages")
        ]);

        const dataComp = await resComp.json();
        const dataImg = await resImg.json();

        localStorage.setItem('offline_componentes', JSON.stringify(dataComp.data));
        localStorage.setItem('offline_imagens', JSON.stringify(dataImg.data));
        bancoImagens = dataImg.data;

        const ativos = dataComp.data.filter(c => c.Ativo && c.Ativo.toString().toUpperCase().trim() === "SIM");
        renderizar(ativos);
        if (force) alert("Lista atualizada!");

      } catch (e) {
        container.innerHTML = "Erro ao conectar.";
        if (cachedComp) {
          renderizar(JSON.parse(cachedComp).filter(c => c.Ativo && c.Ativo.toString().toUpperCase().trim() === "SIM"));
        }
      }
    }

    async function fetchImages() {
      try {
        const res = await fetch(SCRIPT_URL + "?action=getImages");
        const json = await res.json();
        bancoImagens = json.data;
        localStorage.setItem('offline_imagens', JSON.stringify(json.data));
      } catch (e) { }
    }

    function renderizar(lista) {
      const container = document.getElementById('listaComponentes');
      container.innerHTML = '';

      lista.forEach(item => {
        const nomeLimpo = item.Nome.trim();
        const idHTML = nomeLimpo.replace(/\s/g, '');

        // Lógica de Imagem Local com Fallback
        const nomeArquivoPlanilha = item.Foto ? item.Foto.split('/').pop() : "";
        const fotoObj = bancoImagens.find(img => img.nome === nomeArquivoPlanilha);
        const urlFotoPlanilha = fotoObj ? fotoObj.url : "https://via.placeholder.com/150?text=Foto";

        // Caminho local sugerido
        const urlFotoLocal = `assets/equipe/${nomeLimpo}.jpg`;

        const card = document.createElement('div');
        card.className = 'comp-card';
        card.innerHTML = `
        <div class="comp-header" onclick="this.parentElement.classList.toggle('active')">
          <img src="${urlFotoLocal}" 
               class="avatar" 
               onerror="if(this.src.indexOf('${urlFotoPlanilha}') == -1) { this.src='${urlFotoPlanilha}'; } else { this.src='https://via.placeholder.com/150?text=Foto'; }">
          <div class="comp-info-main">
            <div class="comp-name">${nomeLimpo}</div>
            <span class="comp-status">ATIVO</span>
          </div>
          <i class="fas fa-chevron-down" style="color:#ccc"></i>
        </div>
        
        <div class="comp-details">
          <div style="font-size:0.8rem; color:#666"><i class="fas fa-tag"></i> ${item.Função}</div>
          
          <div class="action-btns">
            <a href="tel:${item["Tel sem Espaço"]}" class="btn-icon btn-tel"><i class="fas fa-phone"></i> Ligar</a>
            <a href="${item.Whatsapp?.link || '#'}" target="_blank" class="btn-icon btn-wpp"><i class="fab fa-whatsapp"></i> WhatsApp</a>
          </div>

          <div class="extra-section">
            <h4><i class="fas fa-calendar-check"></i> Próximas Escalas</h4>
            <div id="esc-${idHTML}" class="loading-small">Buscando...</div>
          </div>

          <div class="extra-section">
            <h4><i class="fas fa-music"></i> Últimas Músicas (Tom)</h4>
            <div id="hist-${idHTML}" class="loading-small">Verificando...</div>
          </div>
        </div>
      `;
        container.appendChild(card);
        buscarEscalas(nomeLimpo, idHTML);
        buscarHistorico(nomeLimpo, idHTML, item.Função);
      });
    }

    async function buscarEscalas(nome, id) {
      const box = document.getElementById(`esc-${id}`);
      const iconsMap = { "Ministro": "fa-microphone-lines", "Back": "fa-microphone", "Violão": "fa-guitar", "Guitarra": "fa-guitar-electric", "Teclado": "fa-keyboard", "Bateria": "fa-drum", "Baixo": "fa-drum-steelpan" };

      try {
        // Tenta usar cache global de escalas se existir
        let data = [];
        const cachedEscala = localStorage.getItem('offline_escala');

        if (cachedEscala) {
          data = JSON.parse(cachedEscala);
        } else {
          const res = await fetch(SCRIPT_URL + "?sheet=Transformar");
          const json = await res.json();
          data = json.data;
          // Não salva cache aqui para não conflitar com a lógica central
        }

        const escalasPessoa = data.filter(e => e.Nome && e.Nome.trim().toLowerCase() === nome.trim().toLowerCase());

        if (escalasPessoa.length > 0) {
          const agrupado = {};
          escalasPessoa.forEach(e => {
            const chave = (e["Nome dos Cultos"] || 'Culto') + (e.Data || '');
            if (!agrupado[chave]) { agrupado[chave] = { nomeCulto: e["Nome dos Cultos"] || 'Culto', dataRaw: e.Data, funcoes: [] }; }
            if (e.Função) agrupado[chave].funcoes.push(e.Função.trim());
          });
          const listaAgrupada = Object.values(agrupado).slice(0, 3);
          box.innerHTML = listaAgrupada.map(e => {
            let dataFormatada = "---";
            if (e.dataRaw) { const d = new Date(e.dataRaw); dataFormatada = ("0" + d.getUTCDate()).slice(-2) + "/" + ("0" + (d.getUTCMonth() + 1)).slice(-2); }
            const funcoesHtml = e.funcoes.map(f => {
              const iconClass = iconsMap[f] || "fa-music";
              return `<span><i class="fa-solid ${iconClass}" style="font-size:0.7rem"></i> ${f}</span>`;
            }).join(' <span style="color:#ccc">|</span> ');
            return `
            <div class="list-item" style="flex-direction: column; align-items: flex-start; gap: 4px; padding: 8px 0;">
              <div style="display: flex; justify-content: space-between; width: 100%; font-weight: 600; color: #2c3e50;">
                <span><i class="far fa-calendar-check" style="color:#3498db"></i> ${dataFormatada}</span>
                <span style="font-size: 0.8rem;"><i class="fas fa-church" style="color:#95a5a6"></i> ${e.nomeCulto}</span>
              </div>
              <div style="display: flex; flex-wrap: wrap; gap: 8px; color: #7f8c8d; font-size: 0.75rem; padding-left: 2px;">${funcoesHtml}</div>
            </div>`;
          }).join('');
        } else {
          box.innerHTML = '<div class="loading-small">Nenhuma escala encontrada.</div>';
        }
      } catch (e) { box.innerHTML = '<div class="loading-small">Erro.</div>'; }
    }

    async function buscarHistorico(nome, id, funcao) {
      const box = document.getElementById(`hist-${id}`);
      const f = funcao.toUpperCase();
      if (!f.includes("MINISTRO") && !f.includes("BACK")) { box.innerHTML = "Histórico disponível para vocal."; return; }

      try {
        // Tenta cache historico
        let data = [];
        const cachedHist = localStorage.getItem('offline_historico');
        if (cachedHist) {
          data = JSON.parse(cachedHist);
        } else {
          const res = await fetch(SCRIPT_URL + "?sheet=Historico%20de%20Músicas");
          const json = await res.json();
          data = json.data;
          localStorage.setItem('offline_historico', JSON.stringify(data));
        }

        const historico = data.filter(h => h.Cantor && h.Cantor.trim() === nome).reverse().slice(0, 3);
        box.innerHTML = historico.length > 0 ?
          historico.map(h => `<div class="list-item"><span>${h.Música || h.Músicas}</span><span>(${h.Tom || h.Tons || '--'})</span></div>`).join('') :
          "Sem histórico.";
      } catch (e) { box.innerHTML = "Erro."; }
    }

    window.onload = () => iniciar();
  </script>

</body>

</html>